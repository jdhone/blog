<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Scraping the Web With Puppeteer: Lessons-learned › Nick Drane</title>
  <meta name="author" content="Nick Drane">
  
  <meta name="description" content="Nick Drane&#39;s blog about programming and modern web development, particularly Node.js and React.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Scraping the Web With Puppeteer: Lessons-learned"/>
  <meta property="og:site_name" content="Nick Drane"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Nick Drane" type="application/atom+xml">

  <link rel="stylesheet" href="/css/style.css"  media="none" onload="if(media!='all')media='all'">
  <noscript><link rel="stylesheet" href="css.css"></noscript>

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
	<script>
		(function (i, s, o, g, r, a, m) {
		i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
			(i[r].q = i[r].q || []).push(arguments)
		}, i[r].l = 1 * new Date(); a = s.createElement(o),
			m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
		})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

		ga('create', 'UA-107252357-1', 'auto');
		ga('send', 'pageview');

	</script>
	
</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">Nick Drane</a></h1>
  <h2><a href="/">Learn Modern Web Development</a></h2>
  <nav id="main-nav">
    <ul>
      
      <li><a href="/about">About</a></li>
      
      <li><a href="/projects">Projects</a></li>
      
      <li><a href="/archives">Archives</a></li>
      
      <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title">Scraping the Web With Puppeteer: Lessons-learned</h1>
  

      
        <time datetime="2017-11-30T18:20:20.000Z">2017-11-30</time>
      
    </header>
    <div class="entry">
      
        <p>I’m currently contracted with <a href="https://www.fraight.ai/" target="_blank" rel="external">Fraight</a> to create a web service using some data from a third party Angular application. I worked off a existing proof of concept codebase that used Chrome’s new <a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="external">Puppeteer</a> API to scrape this site. I strongly regret not starting from scratch.</p>
<h2 id="What-is-Puppeteer"><a href="#What-is-Puppeteer" class="headerlink" title="What is Puppeteer?"></a>What is Puppeteer?</h2><p>Puppeteer is a Node API that allows you to control Google’s headless Chrome browser. Imagine a version of your browser that can send and receive requests but has no GUI. It just performs everything in the background, performing actions as instructed by an API. This makes Puppeteer great for end to end testing a web application. You can truly simulate the user experience, typing where they type and clicking where they click. Another use case for Puppeteer is web scraping a Single Page Application or an application where the content is rendered entirely server side. We are going to look at scraping a SPA today.</p>
<h2 id="A-Simple-Example"><a href="#A-Simple-Example" class="headerlink" title="A Simple Example"></a>A Simple Example</h2><p>First you need to create an instance of the headless browser and navigate to a webpage. Perhaps we want to fill out a login form, logging into a website.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch()</div><div class="line"><span class="keyword">const</span> page = <span class="keyword">await</span> <span class="keyword">this</span>.browser.newPage();</div><div class="line"><span class="keyword">await</span> page.goto(<span class="string">"https://website/login"</span>);</div></pre></td></tr></table></figure>
<p>In an ideal situation, filling out and submitting the form will look something like this.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">// Provide the selector of an input box and the content to type</span></div><div class="line"><span class="keyword">await</span> page.type(<span class="string">"input#username"</span>, CREDENTIALS.username);</div><div class="line"><span class="keyword">await</span> page.type(<span class="string">"input#password"</span>, CREDENTIALS.password);</div><div class="line"><span class="keyword">await</span> page.click(<span class="string">"button#login"</span>); <span class="comment">// Click the login button</span></div><div class="line"></div><div class="line"><span class="comment">// Wait until the screen changes and a node matching</span></div><div class="line"><span class="comment">// the selector #logged-in-successfully appears,</span></div><div class="line"><span class="comment">// at which point we know the login was successful</span></div><div class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">"#logged-in-successfully"</span>);</div></pre></td></tr></table></figure>
<p>We just successfully filled out a form and submitted an HTTP request containing our form data to a server. This is where Puppeteer shines. Let’s look at a more complicated example.</p>
<h2 id="A-More-Complicated-Example"><a href="#A-More-Complicated-Example" class="headerlink" title="A More Complicated Example"></a>A More Complicated Example</h2><p>Today’s web uses a mix of simple html driven forms as well as more complicated, javascript-driven forms, rich with functionality like autocomplete and dynamic dropdown menus. And of course there is the ubiquitous calendar date picker. These components each need to be treated differently.</p>
<p>Here is some a heavily modified version of some code I wrote for Fraight:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> fields = &#123;</div><div class="line">  equipment: <span class="string">'input[ng-model="equipment"]'</span>,</div><div class="line">  origin: <span class="string">'input[ng-model="origin"]'</span>,</div><div class="line">  destination: <span class="string">'input[ng-model="destination"]'</span>,</div><div class="line">  date: <span class="string">'input[ng-model="date"]'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> searchParams = getSearchParams();</div><div class="line"><span class="keyword">const</span> page = <span class="keyword">await</span> <span class="keyword">this</span>.browser.newPage();</div><div class="line"><span class="keyword">await</span> page.goto(<span class="string">"https://website/search"</span>);</div><div class="line"></div><div class="line"><span class="comment">// We need to click a button to make the search form appear</span></div><div class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">".new-search"</span>);</div><div class="line"><span class="keyword">await</span> page.click(<span class="string">".new-search"</span>);</div><div class="line"></div><div class="line"><span class="comment">// Fill out the form</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">const</span> field <span class="keyword">of</span> <span class="built_in">Object</span>.keys(fields)) &#123;</div><div class="line">  <span class="keyword">if</span> (searchParams[field]) &#123;</div><div class="line">    <span class="keyword">const</span> selector = fields[field];</div><div class="line"></div><div class="line">    <span class="comment">// We want to make sure each DOM node is accessible before</span></div><div class="line">    <span class="comment">// we try to do anything to it.</span></div><div class="line">    <span class="keyword">await</span> page.waitForSelector(selector);</div><div class="line"></div><div class="line">    <span class="comment">// Some inputs need to be focused first for page.type to work</span></div><div class="line">    <span class="comment">// Might as well focus on all of them</span></div><div class="line">    <span class="keyword">await</span> page.focus(selector);</div><div class="line"></div><div class="line">    <span class="comment">// Some inputs have defaults that need to be erased before typing</span></div><div class="line">    <span class="comment">// your own input</span></div><div class="line">    <span class="keyword">if</span> (field === <span class="string">"date"</span> || field === <span class="string">"equipment"</span>) &#123;</div><div class="line">      <span class="keyword">await</span> deleteInput(page, selector);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">await</span> page.type(selector, searchParams[field]);</div><div class="line"></div><div class="line">    <span class="comment">// This field won't register the typed data until Enter is pressed.</span></div><div class="line">    <span class="comment">// This is beacuse the equipment field is a dropdown where one of a</span></div><div class="line">    <span class="comment">// specific set of inputs must be clicked.</span></div><div class="line">    <span class="keyword">if</span> (field === <span class="string">"equipment"</span>) &#123;</div><div class="line">      <span class="keyword">await</span> page.keyboard.press(<span class="string">"Enter"</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The first thing to notice is that the code is messy. It’s full of weird exceptions, each of which was discovered through trial and error. The worst thing about this code is that it doesn’t always work.</p>
<h2 id="Brace-Yourself-for-Flaky-Behavior"><a href="#Brace-Yourself-for-Flaky-Behavior" class="headerlink" title="Brace Yourself for Flaky Behavior"></a>Brace Yourself for Flaky Behavior</h2><p>Working with Puppeteer was truly an exercise in guesswork. My code often worked some percentage of the time. This non-deterministic, flaky behavior is what made this project so challenging. My code needs to be reliable and to have consistent behavior, but the reality of the matter is that given the exact same inputs, Puppeteer did not always produce the same outputs. I was required to do a lot of unnecessary engineering to increase reliability, which was a truly frustrating considering the alternative.</p>
<h2 id="Puppeteer-Was-Completely-Unnecessary"><a href="#Puppeteer-Was-Completely-Unnecessary" class="headerlink" title="Puppeteer Was Completely Unnecessary"></a>Puppeteer Was Completely Unnecessary</h2><p>Puppeteer has a API that allows you to execute arbitrary code against the DOM. After scraping form results with this API and getting the same flaky behavior I described above, I completely ditched the approach and started grabbing data from the HTTP response objects themselves. I wrote some handy code that allowed me to do this. Below is the code without error handling.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">waitForUrl(page, urlPrefix) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    page.on(<span class="string">"response"</span>, res =&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (!res.url.startsWith(urlPrefix)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      resolve(res.json());</div><div class="line">    &#125;;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The page passed into this function is the same page object created above by the Puppeteer API. Among other things, it is an event emitter that allows me that listen for any HTTP responses received. I’ve essentially created a promise that resolves to the response of a particular ajax request. This allowed me interact with the server API directly and remove the DOM from the data retrieval process, greatly reducing the chance for flaky behavior. But that begs the question, why use Puppeteer at all? Why not simply send http requests to the server API manually and ditch the complicated form submission code above?<br>That’s really how I should have started all along.</p>
<h2 id="When-is-Puppeteer-the-Right-Solution"><a href="#When-is-Puppeteer-the-Right-Solution" class="headerlink" title="When is Puppeteer the Right Solution"></a>When is Puppeteer the Right Solution</h2><p>Puppeteer is the appropriate tool for scraping when a simple server API is inaccessible. If the information you want to extract from the webpage is generated using a combination of data from a server API and javascript code, then you have a great use case for Puppeteer. If all you need is data from the server, go the simple route and hit the API with an HTTP library like <a href="https://github.com/axios/axios" target="_blank" rel="external">axios</a> or <a href="https://github.com/request/request" target="_blank" rel="external">request</a></p>

      
    </div>
      
      <footer>
        
  
  <div class="categories">
    <a href="/categories/Javascript/">Javascript</a>, <a href="/categories/Web-Scraping/">Web Scraping</a>
  </div>

        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>


<section id="comment">
  
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:nickdrane.com">
  </form>
</div>

  
  <div class="widget tag about">
    <ul class="entry">
      <div>
        <img class="about-photo" src="/images/about-photo.jpg" alt="photo of Nick Drane"/>
      </div>
      <p class="about-photo-text"> Nick Drane's blog about programming, hacking, software, computer security, and compute science.</p>

    </ul>
  </div>
  




  
<div class="widget tag recent-posts">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/scraping-the-web-with-puppeteer-lessons-learned/">Scraping the Web With Puppeteer: Lessons-learned</a>
      </li>
    
      <li>
        <a href="/build-your-own-regex/">Build a Regex Engine in Less than 40 Lines of Code</a>
      </li>
    
      <li>
        <a href="/write-your-own-redux-connect/">Write Your Own React-Redux Connect</a>
      </li>
    
      <li>
        <a href="/using-reduce/">Using Reduce</a>
      </li>
    
      <li>
        <a href="/leveraging-immutability-in-react/">Leveraging Immutability in React</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag category">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Functional-Programming/">Functional Programming</a><small>1</small></li>
  
    <li><a href="/categories/Immutability/">Immutability</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>2</small></li>
  
    <li><a href="/categories/React/">React</a><small>2</small></li>
  
    <li><a href="/categories/Recursion/">Recursion</a><small>1</small></li>
  
    <li><a href="/categories/Redux/">Redux</a><small>1</small></li>
  
    <li><a href="/categories/Regular-Expressions/">Regular Expressions</a><small>1</small></li>
  
    <li><a href="/categories/Web-Scraping/">Web Scraping</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 Nick Drane
  
</div>
<div class="clearfix"></div></footer>
  

</body>
</html>

